{
  "AWSTemplateFormatVersion": "2010-09-09",
  "Parameters": {
    "CodeRepository": {
      "Type": "String",
      "Default": "ecog2-coderepository",
      "Description": "S3 bucket that contains the application code.  Must be in same region as environment."
    },
    "DevDayStartHour": {
      "Type": "String",
      "Default": "12",
      "AllowedValues": [
        "0", "1", "2", "3", "4", "5", 
        "6", "7", "8", "9", "10", "11", 
        "12", "13", "14", "15", "16", "17", 
        "18", "19", "20", "21", "22", "23"
      ],
      "Description": "Hour when developer day starts (in UTC) [0-23]."
    },
    "DevDayStopHour": {
      "Type": "String",
      "Default": "23",
      "AllowedValues": [
        "0", "1", "2", "3", "4", "5", 
        "6", "7", "8", "9", "10", "11", 
        "12", "13", "14", "15", "16", "17", 
        "18", "19", "20", "21", "22", "23"
      ],
      "Description": "Hour when developer day ends (in UTC) [0-23]."
    },
    "DevWeekStart": {
      "Type": "String",
      "Default": "MON",
      "AllowedValues": [
        "MON",
        "TUE",
        "WED",
        "THU",
        "FRI",
        "SAT",
        "SUN"
      ],
      "Description": "First work day of week for developers."
    },
    "DevWeekEnd": {
      "Type": "String",
      "Default": "FRI",
      "AllowedValues": [
        "MON",
        "TUE",
        "WED",
        "THU",
        "FRI",
        "SAT",
        "SUN"
      ],
      "Description": "Last work day of week for developers."
    },
    "BizDayStartHour": {
      "Type": "String",
      "Default": "13",
      "AllowedValues": [
        "0", "1", "2", "3", "4", "5", 
        "6", "7", "8", "9", "10", "11", 
        "12", "13", "14", "15", "16", "17", 
        "18", "19", "20", "21", "22", "23"
      ],
      "Description": "Hour when business day starts (in UTC) [0-23]."
    },
    "BizDayStopHour": {
      "Type": "String",
      "Default": "23",
      "AllowedValues": [
        "0", "1", "2", "3", "4", "5", 
        "6", "7", "8", "9", "10", "11", 
        "12", "13", "14", "15", "16", "17", 
        "18", "19", "20", "21", "22", "23"
      ],
      "Description": "Hour when business day ends (in UTC) [0-23]."
    },
    "BizWeekStart": {
      "Type": "String",
      "Default": "MON",
      "AllowedValues": [
        "MON",
        "TUE",
        "WED",
        "THU",
        "FRI",
        "SAT",
        "SUN"
      ],
      "Description": "First work day of week for business."
    },
    "BizWeekEnd": {
      "Type": "String",
      "Default": "FRI",
      "AllowedValues": [
        "MON",
        "TUE",
        "WED",
        "THU",
        "FRI",
        "SAT",
        "SUN"
      ],
      "Description": "Last work day of week for business."
    },
    "ScaleUpHour": {
      "Type": "String",
      "Default": "13",
      "AllowedValues": [
        "0", "1", "2", "3", "4", "5", 
        "6", "7", "8", "9", "10", "11", 
        "12", "13", "14", "15", "16", "17", 
        "18", "19", "20", "21", "22", "23"
      ],
      "Description": "Hour when instances should be scaled up (in UTC) [0-23]."
    },
    "ScaleDownHour": {
      "Type": "String",
      "Default": "23",
      "AllowedValues": [
        "0", "1", "2", "3", "4", "5", 
        "6", "7", "8", "9", "10", "11", 
        "12", "13", "14", "15", "16", "17", 
        "18", "19", "20", "21", "22", "23"
      ],
      "Description": "Hour when instances should be scaled down  (in UTC) [0-23]."
    },
    "VerticalPilotWeekStart": {
      "Type": "String",
      "Default": "MON",
      "AllowedValues": [
        "MON",
        "TUE",
        "WED",
        "THU",
        "FRI",
        "SAT",
        "SUN"
      ],
      "Description": "First day of week for scaling up."
    },
    "VerticalPilotWeekEnd": {
      "Type": "String",
      "Default": "FRI",
      "AllowedValues": [
        "MON",
        "TUE",
        "WED",
        "THU",
        "FRI",
        "SAT",
        "SUN"
      ],
      "Description": "Last day of week for scaling down."
    }
  },
  "Metadata" : {
    "AWS::CloudFormation::Interface" : {
      "ParameterGroups" : [
        {
          "Label" : { "default" : "Code Location" },
          "Parameters" : [ "CodeRepository" ]
        },
        {
          "Label" : { "default":"Developer Schedule Configuration (Controls Start/Stop for DEV_WEEK tagged instances)" },
          "Parameters" : [ 
            "DevWeekStart", 
            "DevWeekEnd",           
            "DevDayStartHour", 
            "DevDayStopHour" ]
        },
        {
          "Label" : { "default":"Business Schedule Configuration (Controls Start/Stop for BIZ_WEEK tagged instances)" },
          "Parameters" : [ 
            "BizWeekStart", 
            "BizWeekEnd",           
            "BizDayStartHour", 
            "BizDayStopHour" ]
        },
        {
          "Label" : { "default": "Vertical Pilot Light Scaling Schedule  (Controls instance scaling for OP_MODE of VERTICAL_PILOT with SCALE_UP/SCALE_DOWN tags.)" },
          "Parameters" : [ 
            "VerticalPilotWeekStart", 
            "VerticalPilotWeekEnd",           
            "ScaleUpHour", 
            "ScaleDownHour" ]
        }
      ],
      "ParameterLabels" : {
        "DevWeekStart" : { "default" : "Which day is the start of the deveoper's work week?" },
        "DevWeekEnd" : { "default" : "Which day is the end of the deveoper's work week?" },
        "DevDayStartHour" : { "default" : "What hour do you want to start your developer instances?" },
        "DevDayStopHour" : { "default" : "What hour do you want to stop your developer instances?" },
        "BizWeekStart" : { "default" : "Which day is the start of the business week?" },
        "BizWeekEnd" : { "default" : "Which day is the end of the business week?" },
        "BizDayStartHour" : { "default" : "What hour do you want to start your business instances?" },
        "BizDayStopHour" : { "default" : "What hour do you want to stop your business instances?" },
        "VerticalPilotWeekStart" : { "default" : "Which day does vertical scaling start?" },
        "VerticalPilotWeekEnd" : { "default" : "Which day does vertical scaling end?" },           
        "ScaleUpHour" : { "default" : "What hour do you want to scale up your instances?" },
        "ScaleDownHour" : { "default" : "What hour do you want to scale down your instances?" }
      }
    }
  },
  "Resources": {
    "EC2LambdaDynamoRole": {
      "Type": "AWS::IAM::Role",
      "Properties": {
        "AssumeRolePolicyDocument": {
          "Version": "2012-10-17",
          "Statement": [
            {
              "Effect": "Allow",
              "Principal": {
                "Service": [
                  "lambda.amazonaws.com"
                ]
              },
              "Action": [
                "sts:AssumeRole"
              ]
            }
          ]
        },
        "ManagedPolicyArns": [
          "arn:aws:iam::aws:policy/AmazonEC2FullAccess",
          "arn:aws:iam::aws:policy/AmazonDynamoDBFullAccess",
          "arn:aws:iam::aws:policy/CloudWatchLogsFullAccess"
        ],
        "RoleName": "EC2LambdaDynamoRole"
      }
    },
    "EC2StarterLambda": {
      "Type": "AWS::Lambda::Function",
      "Properties": {
        "Code": {
          "S3Bucket": { "Ref": "CodeRepository" },
          "S3Key": "EC2-Starter-Lambda.zip"
        },
        "Description": "Lambda function to start EC2 Instances and make entry in audit table.",
        "FunctionName": "EC2-Starter-Lambda",
        "Handler": "EC2-Starter-Lambda.lambda_handler",
        "Role": {
          "Fn::GetAtt": [
            "EC2LambdaDynamoRole",
            "Arn"
          ]
        },
        "Runtime": "python2.7",
        "Timeout": "300"
      }
    },
    "EC2StopperLambda": {
      "Type": "AWS::Lambda::Function",
      "Properties": {
        "Code": {
          "S3Bucket": { "Ref": "CodeRepository" },
          "S3Key": "EC2-Stopper-Lambda.zip"
        },
        "Description": "Lambda function to stop EC2 Instances and make entry in audit table.",
        "FunctionName": "EC2-Stopper-Lambda",
        "Handler": "EC2-Stopper-Lambda.lambda_handler",
        "Role": {
          "Fn::GetAtt": [
            "EC2LambdaDynamoRole",
            "Arn"
          ]
        },
        "Runtime": "python2.7",
        "Timeout": "300"
      }
    },
    "EC2VerticalScalerStopperLambda": {
      "Type": "AWS::Lambda::Function",
      "Properties": {
        "Code": {
          "S3Bucket": { "Ref": "CodeRepository" },
          "S3Key": "EC2-VerticalScalerStopper-Lambda.zip"
        },
        "Description": "Lambda function to stop EC2 instances for vertical scaling and insert row into state table",
        "FunctionName": "EC2-VerticalScalerStopper-Lambda",
        "Handler": "EC2-VerticalScalerStopper-Lambda.lambda_handler",
        "Role": {
          "Fn::GetAtt": [
            "EC2LambdaDynamoRole",
            "Arn"
          ]
        },
        "Runtime": "python2.7",
        "Timeout": "300"
      }
    },
    "EC2VerticalScalerRestarterLambda": {
      "Type": "AWS::Lambda::Function",
      "Properties": {
        "Code": {
          "S3Bucket": { "Ref": "CodeRepository" },
          "S3Key": "EC2-VerticalScalerRestarter-Lambda.zip"
        },
        "Description": "Lambda function to change instance type, restart EC2 instance and make entry in audit table.",
        "FunctionName": "EC2-VerticalScalerRestarter-Lambda",
        "Handler": "EC2-VerticalScalerRestarter-Lambda.lambda_handler",
        "Role": {
          "Fn::GetAtt": [
            "EC2LambdaDynamoRole",
            "Arn"
          ]
        },
        "Runtime": "python2.7",
        "Timeout": "300"
      }
    },
    "ScaleUpScheduledRule": {
      "Type": "AWS::Events::Rule",
      "Properties": {
        "Name": "VERTICAL_PILOT-scale_up",
        "Description": "Scale Up instances with OP_MODE of VERTICAL_PILOT.",
        "ScheduleExpression": {
          "Fn::Join": [
            "", 
            [ 
              "cron(0 ",
              { "Ref" : "ScaleUpHour" },
              " ? * ",
              { "Ref" : "VerticalPilotWeekStart" },
              "-",
              { "Ref" : "VerticalPilotWeekEnd" },
              " *)"
            ]
          ]
        },
        "State": "ENABLED",
        "Targets": [{
          "Arn": { "Fn::GetAtt": ["EC2VerticalScalerStopperLambda", "Arn"] },
          "Id": "VERTICAL_PILOT-EC2-Scaler",
          "Input": "{ \"OpMode\" : \"VERTICAL_PILOT\", \"Action\" : \"SCALE_UP\" }"
        }]
      }
    },
    "ScaleDownScheduledRule": {
      "Type": "AWS::Events::Rule",
      "Properties": {
        "Name": "VERTICAL_PILOT-scale_down",
        "Description": "Scale Down instances with OP_MODE of VERTICAL_PILOT.",
        "ScheduleExpression": {
          "Fn::Join": [
            "", 
            [ 
              "cron(0 ",
              { "Ref" : "ScaleDownHour" },
              " ? * ",
              { "Ref" : "VerticalPilotWeekStart" },
              "-",
              { "Ref" : "VerticalPilotWeekEnd" },
              " *)"
            ]
          ]
        },
        "State": "ENABLED",
        "Targets": [{
          "Arn": { "Fn::GetAtt": ["EC2VerticalScalerStopperLambda", "Arn"] },
          "Id": "VERTICAL_PILOT-EC2-Scaler",
          "Input": "{ \"OpMode\" : \"VERTICAL_PILOT\", \"Action\" : \"SCALE_DOWN\" }"
        }]
      }
    },
    "ScalerRestartRule": {
      "Type": "AWS::Events::Rule",
      "Properties": {
        "Name": "VERTICAL_PILOT-restart",
        "Description": "Restart instance that has been stopped due to a vertical scaling event.",
          "EventPattern": {
            "source": [
              "aws.ec2"
            ],
            "detail-type": [
              "EC2 Instance State-change Notification"
            ],
            "detail": {
              "state": [
                "stopped"
              ]
            }
          },
        "State": "ENABLED",
        "Targets": [{
          "Arn": { "Fn::GetAtt": ["EC2VerticalScalerRestarterLambda", "Arn"] },
          "Id": "VERTICAL_PILOT-EC2-Restarter"
        }]
      }
    },
    "PermissionForEventsToInvokeScaleUpStop": {
      "Type": "AWS::Lambda::Permission",
      "Properties": {
        "FunctionName": { "Ref": "EC2VerticalScalerStopperLambda" },
        "Action": "lambda:InvokeFunction",
        "Principal": "events.amazonaws.com",
        "SourceArn": { "Fn::GetAtt": ["ScaleUpScheduledRule", "Arn"] }
      }
    },
    "PermissionForEventsToInvokeScaleDownStop": {
      "Type": "AWS::Lambda::Permission",
      "Properties": {
        "FunctionName": { "Ref": "EC2VerticalScalerStopperLambda" },
        "Action": "lambda:InvokeFunction",
        "Principal": "events.amazonaws.com",
        "SourceArn": { "Fn::GetAtt": ["ScaleDownScheduledRule", "Arn"] }
      }
    },
    "PermissionForEventsToInvokeScalerRestart": {
      "Type": "AWS::Lambda::Permission",
      "Properties": {
        "FunctionName": { "Ref": "EC2VerticalScalerRestarterLambda" },
        "Action": "lambda:InvokeFunction",
        "Principal": "events.amazonaws.com",
        "SourceArn": { "Fn::GetAtt": ["ScalerRestartRule", "Arn"] }
      }
    },
    "DevWeekStartScheduledRule": {
      "Type": "AWS::Events::Rule",
      "Properties": {
        "Name": "DEV_WEEK-start",
        "Description": "Start instances with OP_MODE of DEV_WEEK.",
        "ScheduleExpression": {
          "Fn::Join": [
            "", 
            [ 
              "cron(0 ",
              { "Ref" : "DevDayStartHour" },
              " ? * ",
              { "Ref" : "DevWeekStart" },
              "-",
              { "Ref" : "DevWeekEnd" },
              " *)"
            ]
          ]
        },
        "State": "ENABLED",
        "Targets": [{
          "Arn": { "Fn::GetAtt": ["EC2StarterLambda", "Arn"] },
          "Id": "DEV_WEEK-EC2-Starter",
          "Input": "{ \"OpMode\" : \"DEV_WEEK\" }"
        }]
      }
    },
    "PermissionForEventsToInvokeDevStarter": {
      "Type": "AWS::Lambda::Permission",
      "Properties": {
        "FunctionName": { "Ref": "EC2StarterLambda" },
        "Action": "lambda:InvokeFunction",
        "Principal": "events.amazonaws.com",
        "SourceArn": { "Fn::GetAtt": ["DevWeekStartScheduledRule", "Arn"] }
      }
    },
    "DevWeekStopScheduledRule": {
      "Type": "AWS::Events::Rule",
      "Properties": {
        "Name": "DEV_WEEK-stop",
        "Description": "Stop instances with OP_MODE of DEV_WEEK.",
        "ScheduleExpression": {
          "Fn::Join": [
            "", 
            [ 
              "cron(0 ",
              { "Ref" : "DevDayStopHour" },
              " ? * ",
              { "Ref" : "DevWeekStart" },
              "-",
              { "Ref" : "DevWeekEnd" },
              " *)"
            ]
          ]
        },
        "State": "ENABLED",
        "Targets": [{
          "Arn": { "Fn::GetAtt": ["EC2StopperLambda", "Arn"] },
          "Id": "DEV_WEEK-EC2-Stopper",
          "Input": "{ \"OpMode\" : \"DEV_WEEK\" }"
        }]
      }
    },
    "PermissionForEventsToInvokeDevStopper": {
      "Type": "AWS::Lambda::Permission",
      "Properties": {
        "FunctionName": { "Ref": "EC2StopperLambda" },
        "Action": "lambda:InvokeFunction",
        "Principal": "events.amazonaws.com",
        "SourceArn": { "Fn::GetAtt": ["DevWeekStopScheduledRule", "Arn"] }
      }
    },
    "BizWeekStartScheduledRule": {
      "Type": "AWS::Events::Rule",
      "Properties": {
        "Name": "BIZ_WEEK-start",
        "Description": "Start instances with OP_MODE of BIZ_WEEK.",
        "ScheduleExpression": {
          "Fn::Join": [
            "", 
            [ 
              "cron(0 ",
              { "Ref" : "BizDayStartHour" },
              " ? * ",
              { "Ref" : "BizWeekStart" },
              "-",
              { "Ref" : "BizWeekEnd" },
              " *)"
            ]
          ]
        },
        "State": "ENABLED",
        "Targets": [{
          "Arn": { "Fn::GetAtt": ["EC2StarterLambda", "Arn"] },
          "Id": "BIZ_WEEK-EC2-Starter",
          "Input": "{ \"OpMode\" : \"BIZ_WEEK\" }"
        }]
      }
    },
    "PermissionForEventsToInvokeBizStarter": {
      "Type": "AWS::Lambda::Permission",
      "Properties": {
        "FunctionName": { "Ref": "EC2StarterLambda" },
        "Action": "lambda:InvokeFunction",
        "Principal": "events.amazonaws.com",
        "SourceArn": { "Fn::GetAtt": ["BizWeekStartScheduledRule", "Arn"] }
      }
    },
    "BizWeekStopScheduledRule": {
      "Type": "AWS::Events::Rule",
      "Properties": {
        "Name": "BIZ_WEEK-stop",
        "Description": "Stop instances with OP_MODE of BIZ_WEEK.",
        "ScheduleExpression": {
          "Fn::Join": [
            "", 
            [ 
              "cron(0 ",
              { "Ref" : "BizDayStopHour" },
              " ? * ",
              { "Ref" : "BizWeekStart" },
              "-",
              { "Ref" : "BizWeekEnd" },
              " *)"
            ]
          ]
        },
        "State": "ENABLED",
        "Targets": [{
          "Arn": { "Fn::GetAtt": ["EC2StopperLambda", "Arn"] },
          "Id": "BIZ_WEEK-EC2-Stopper",
          "Input": "{ \"OpMode\" : \"BIZ_WEEK\" }"
        }]
      }
    },
    "PermissionForEventsToInvokeBizStopper": {
      "Type": "AWS::Lambda::Permission",
      "Properties": {
        "FunctionName": { "Ref": "EC2StopperLambda" },
        "Action": "lambda:InvokeFunction",
        "Principal": "events.amazonaws.com",
        "SourceArn": { "Fn::GetAtt": ["BizWeekStopScheduledRule", "Arn"] }
      }
    },
    "EC2CostManagerAuditTable": {
      "Type": "AWS::DynamoDB::Table",
      "Properties": {
        "AttributeDefinitions": [
          {
            "AttributeName": "InstanceId",
            "AttributeType": "S"
          },
          {
            "AttributeName": "TimeStamp",
            "AttributeType": "S"
          }
        ],
        "KeySchema": [
          {
            "AttributeName": "InstanceId",
            "KeyType": "HASH"
          },
          {
            "AttributeName": "TimeStamp",
            "KeyType": "RANGE"
          }
        ],
        "ProvisionedThroughput": {
          "ReadCapacityUnits": "15",
          "WriteCapacityUnits": "15"
        },
        "TableName": "EC2CostAuditTrail"
      }
    },
    "EC2ScalingStateTable": {
      "Type": "AWS::DynamoDB::Table",
      "Properties": {
        "AttributeDefinitions": [
          {
            "AttributeName": "InstanceId",
            "AttributeType": "S"
          }
        ],
        "KeySchema": [
          {
            "AttributeName": "InstanceId",
            "KeyType": "HASH"
          }
        ],
        "ProvisionedThroughput": {
          "ReadCapacityUnits": "5",
          "WriteCapacityUnits": "5"
        },
        "TableName": "EC2ScalingState"
      }
    }
  }
}